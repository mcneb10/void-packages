# Template file for 'openarena'
pkgname=openarena
version=0.8.8
# Version with no punctuation
_relversion=${version//.}
revision=1
hostmakedepends="pkg-config unzip wget git make"
makedepends="SDL-devel libxmp-devel libvorbis-devel"
depends="SDL curl libopenal libxmp libvorbis"
short_desc="Open source multiplayer ioquake3-based FPS"
maintainer="mcneb10 <mcneb10@yahoo.com>"
license="GPL-2.0-only"
homepage="https://openarena.ws"
_zip_filename="openarena-${version}.zip"
_asset_url="http://download.tuxfamily.org/openarena/rel/${_relversion}/${_zip_filename}"
_asset_checksum=5a8faf7f5b51f351b0a1618c06b6b98a5f1a6758f1d39818de2c87df2a0bac4a
_engine_git_repo="https://github.com/OpenArena/engine.git"
_oa_arch=$(uname -m | sed -e s/i.86/x86/)

do_fetch() {
	mkdir -p $wrksrc
	cd $wrksrc
	wget "${_asset_url}"
	_actual_asset_sum=`sha256sum ${_zip_filename}`
	if [[ ! ${_actual_asset_sum} =~ ${_asset_checksum} ]]; then
		echo -e "Failed to verify openarena assets!\nExpected sha256sum ${_asset_checksum}\n but got ${_actual_asset_sum}"
		exit 1
	fi
	git clone "${_engine_git_repo}"
}

do_extract() {
	unzip "${_zip_filename}"
}

do_build() {
	cd "$wrksrc/engine"
	make ${makejobs} CFLAGS="$(pkg-config --cflags sdl vorbisfile)" LDFLAGS="$(pkg-config --libs sdl vorbisfile)"
}

do_install() {
	# The name of this folder is dependent on the architecture
	cd "$wrksrc/engine/build/release-linux-${_oa_arch}"
	vmkdir usr/share/openarena
	# Again these filenames are architecture depedendent
	vbin "oa_ded.${_oa_arch}"
	vbin "openarena.${_oa_arch}"
	ln -s "/usr/bin/oa_ded.${_oa_arch}" "$DESTDIR/usr/bin/oa_ded"
	ln -s "/usr/bin/openarena.${_oa_arch}" "$DESTDIR/usr/bin/openarena"
	# Go back to copy assets
	cd "$wrksrc/openarena-${version}/"
	vcopy baseoa usr/share/openarena
	vcopy missionpack usr/share/openarena
	# Install the .desktop entry, icon, and stuff
	vinstall "$wrksrc/engine/misc/quake3.png" 644 usr/share/pixmaps openarena.png
	vinstall $FILESDIR/openarena.desktop 644 usr/share/applications
	vinstall $FILESDIR/openarena-server.desktop 644 usr/share/applications
}
